<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservices App - Users & Posts</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 { color: #333; margin-bottom: 10px; }
        .architecture {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
        }
        .microservice {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            font-weight: bold;
        }
        .ms-1 { background: #e3f2fd; color: #1976d2; }
        .ms-2 { background: #fff3e0; color: #f57c00; }
        .gateway { background: #f3e5f5; color: #7b1fa2; }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card h2 { color: #667eea; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea { resize: vertical; min-height: 100px; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        .btn-delete {
            background: #dc3545;
            padding: 6px 15px;
            font-size: 12px;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        tr:hover { background: #f8f9fa; }
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .post-content {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 14px;
        }
        .user-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Application Microservices</h1>
            <p>Architecture Three-Tier avec 2 Microservices communiquant</p>
            <div class="architecture">
                <span class="gateway">API Gateway (Nginx)</span>
                <span>‚Üí</span>
                <span class="microservice ms-1">Microservice 1: Users</span>
                <span>+</span>
                <span class="microservice ms-2">Microservice 2: Posts</span>
                <span>‚Üí</span>
                <span>Database (PostgreSQL)</span>
            </div>
            <div>
                <span id="usersStatus" class="status disconnected">Users Service: ...</span>
                <span id="postsStatus" class="status disconnected">Posts Service: ...</span>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">üë• Utilisateurs</button>
            <button class="tab" onclick="switchTab('posts')">üìù Posts</button>
        </div>

        <!-- TAB USERS -->
        <div id="users-tab" class="tab-content active">
            <div class="card">
                <h2>‚ûï Ajouter un Utilisateur</h2>
                <form id="userForm">
                    <div class="form-group">
                        <label>Nom complet</label>
                        <input type="text" id="userName" required placeholder="Jean Dupont">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail" required placeholder="jean@example.com">
                    </div>
                    <button type="submit">Ajouter</button>
                </form>
            </div>

            <div class="card">
                <h2>üë• Liste des Utilisateurs</h2>
                <div id="usersList"><div class="loading">Chargement...</div></div>
            </div>
        </div>

        <!-- TAB POSTS -->
        <div id="posts-tab" class="tab-content">
            <div class="card">
                <h2>‚ûï Cr√©er un Post</h2>
                <form id="postForm">
                    <div class="form-group">
                        <label>Utilisateur</label>
                        <select id="postUserId" required>
                            <option value="">S√©lectionner un utilisateur...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Titre</label>
                        <input type="text" id="postTitle" required placeholder="Titre du post">
                    </div>
                    <div class="form-group">
                        <label>Contenu</label>
                        <textarea id="postContent" required placeholder="Contenu du post..."></textarea>
                    </div>
                    <button type="submit">Cr√©er le Post</button>
                </form>
            </div>

            <div class="card">
                <h2>üìù Liste des Posts</h2>
                <div id="postsList"><div class="loading">Chargement...</div></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            if (tab === 'posts') {
                loadUsersForSelect();
                loadPosts();
            }
        }

        async function checkHealth() {
            try {
                const usersRes = await fetch(`${API_URL}/users/stats`);
                document.getElementById('usersStatus').className = usersRes.ok ? 'status connected' : 'status disconnected';
                document.getElementById('usersStatus').textContent = usersRes.ok ? 'Users Service: ‚úì' : 'Users Service: ‚úó';
            } catch {
                document.getElementById('usersStatus').className = 'status disconnected';
                document.getElementById('usersStatus').textContent = 'Users Service: ‚úó';
            }

            try {
                const postsRes = await fetch(`${API_URL}/posts/stats`);
                document.getElementById('postsStatus').className = postsRes.ok ? 'status connected' : 'status disconnected';
                document.getElementById('postsStatus').textContent = postsRes.ok ? 'Posts Service: ‚úì' : 'Posts Service: ‚úó';
            } catch {
                document.getElementById('postsStatus').className = 'status disconnected';
                document.getElementById('postsStatus').textContent = 'Posts Service: ‚úó';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/users`);
                const data = await response.json();
                const usersList = document.getElementById('usersList');

                if (data.success && data.users && data.users.length > 0) {
                    let html = '<table><thead><tr><th>ID</th><th>Nom</th><th>Email</th><th>Date</th><th>Action</th></tr></thead><tbody>';
                    data.users.forEach(user => {
                        const date = new Date(user.created_at).toLocaleDateString('fr-FR');
                        html += `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>${date}</td>
                                <td><button class="btn-delete" onclick="deleteUser(${user.id})">Supprimer</button></td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    usersList.innerHTML = html;
                } else {
                    usersList.innerHTML = '<div class="empty">üì≠ Aucun utilisateur</div>';
                }
            } catch (error) {
                document.getElementById('usersList').innerHTML = '<div class="empty">‚ùå Erreur de connexion</div>';
            }
        }

        async function loadUsersForSelect() {
            try {
                const response = await fetch(`${API_URL}/users`);
                const data = await response.json();
                const select = document.getElementById('postUserId');
                select.innerHTML = '<option value="">S√©lectionner un utilisateur...</option>';
                
                if (data.success && data.users) {
                    data.users.forEach(user => {
                        select.innerHTML += `<option value="${user.id}">${user.name} (${user.email})</option>`;
                    });
                }
            } catch {}
        }

        async function loadPosts() {
            try {
                const response = await fetch(`${API_URL}/posts`);
                const data = await response.json();
                const postsList = document.getElementById('postsList');

                if (data.success && data.posts && data.posts.length > 0) {
                    let html = '';
                    data.posts.forEach(post => {
                        const date = new Date(post.created_at).toLocaleDateString('fr-FR');
                        html += `
                            <div style="border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0;">${post.title}</h3>
                                    <button class="btn-delete" onclick="deletePost(${post.id})">Supprimer</button>
                                </div>
                                <span class="user-badge">üë§ ${post.user_name}</span>
                                <span style="color: #999; font-size: 12px; margin-left: 10px;">üìÖ ${date}</span>
                                <div class="post-content">${post.content}</div>
                            </div>
                        `;
                    });
                    postsList.innerHTML = html;
                } else {
                    postsList.innerHTML = '<div class="empty">üì≠ Aucun post</div>';
                }
            } catch (error) {
                document.getElementById('postsList').innerHTML = '<div class="empty">‚ùå Erreur de connexion</div>';
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });

                if (response.ok) {
                    showAlert(`Utilisateur ${name} cr√©√© !`, 'success');
                    document.getElementById('userForm').reset();
                    loadUsers();
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'Erreur', 'error');
                }
            } catch {
                showAlert('Erreur de connexion', 'error');
            }
        });

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user_id = document.getElementById('postUserId').value;
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;

            try {
                const response = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(user_id), title, content })
                });

                if (response.ok) {
                    showAlert('Post cr√©√© !', 'success');
                    document.getElementById('postForm').reset();
                    loadPosts();
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'Erreur', 'error');
                }
            } catch {
                showAlert('Erreur de connexion', 'error');
            }
        });

        async function deleteUser(id) {
            if (!confirm('Supprimer cet utilisateur et tous ses posts ?')) return;
            try {
                const response = await fetch(`${API_URL}/users/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showAlert('Utilisateur supprim√©', 'success');
                    loadUsers();
                } else {
                    showAlert('Erreur', 'error');
                }
            } catch {
                showAlert('Erreur de connexion', 'error');
            }
        }

        async function deletePost(id) {
            if (!confirm('Supprimer ce post ?')) return;
            try {
                const response = await fetch(`${API_URL}/posts/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showAlert('Post supprim√©', 'success');
                    loadPosts();
                } else {
                    showAlert('Erreur', 'error');
                }
            } catch {
                showAlert('Erreur de connexion', 'error');
            }
        }

        checkHealth();
        loadUsers();
        setInterval(checkHealth, 30000);
    </script>
</body>
</html>
